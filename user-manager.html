
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 p-6">
  <div class="max-w-3xl mx-auto bg-white border border-slate-200 rounded-2xl shadow p-6">
    <div class="flex items-center justify-between">
      <h1 class="text-xl font-bold text-slate-900">User Manager</h1>
      <a href="/" class="text-sm text-blue-600 hover:underline">← Back to Dashboard</a>
    </div>
    <p class="text-sm text-slate-500 mt-1">Manage Creator/Viewer allow-lists. Admin only.</p>

    <div id="err" class="hidden mt-4 text-sm bg-red-50 border border-red-200 text-red-800 rounded-lg p-3"></div>
    <div id="ok" class="hidden mt-4 text-sm bg-green-50 border border-green-200 text-green-800 rounded-lg p-3"></div>

    <div class="mt-6 grid md:grid-cols-2 gap-6">
      <div>
        <h2 class="text-sm font-semibold text-slate-700">Creators</h2>
        <div class="mt-2 flex gap-2">
          <input id="creatorEmail" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="name@company.com" />
          <button id="addCreator" class="px-3 py-2 bg-indigo-600 text-white rounded-lg text-sm">Add</button>
        </div>
        <ul id="creatorList" class="mt-3 space-y-2"></ul>
      </div>

      <div>
        <h2 class="text-sm font-semibold text-slate-700">Viewers</h2>
        <div class="mt-2 flex gap-2">
          <input id="viewerEmail" class="flex-1 border rounded-lg px-3 py-2 text-sm" placeholder="name@company.com" />
          <button id="addViewer" class="px-3 py-2 bg-slate-900 text-white rounded-lg text-sm">Add</button>
        </div>
        <ul id="viewerList" class="mt-3 space-y-2"></ul>
      </div>
    </div>

    <div class="mt-8 border-t pt-4 flex items-center justify-between">
      <button id="logout" class="text-sm px-3 py-2 rounded-lg bg-red-50 border border-red-200 text-red-700">Logout</button>
      <span id="me" class="text-xs text-slate-500"></span>
    </div>
  </div>

<script>
  const err = (t)=>{ const e=document.getElementById('err'); e.textContent=t; e.classList.remove('hidden'); document.getElementById('ok').classList.add('hidden'); };
  const ok  = (t)=>{ const e=document.getElementById('ok'); e.textContent=t; e.classList.remove('hidden'); document.getElementById('err').classList.add('hidden'); };

  async function apiJson(url, options){
    const r = await fetch(url, Object.assign({ headers:{'Content-Type':'application/json','Accept':'application/json'} }, options||{}));
    const txt = await r.text();
    let j={};
    try{ j=JSON.parse(txt||'{}'); } catch { j={ error: txt }; }
    if(!r.ok) throw new Error(j.error||j.message||txt||('HTTP '+r.status));
    return j;
  }

  function renderList(el, emails, role){
    el.innerHTML='';
    (emails||[]).forEach(email=>{
      const li=document.createElement('li');
      li.className='flex items-center justify-between bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm';
      li.innerHTML = `<span>${email}</span><button class="text-xs px-2 py-1 rounded bg-red-50 border border-red-200 text-red-700">Remove</button>`;
      li.querySelector('button').onclick = async ()=>{
        try{ await apiJson('/api/users', { method:'DELETE', body: JSON.stringify({ role, email }) }); await load(); ok('Removed'); }
        catch(e){ err(e.message); }
      };
      el.appendChild(li);
    });
  }

  async function load(){
    const me = await apiJson('/api/auth/me');
    if(!me.authenticated){ location.href='/login.html?next=' + encodeURIComponent(location.pathname); return; }
    document.getElementById('me').textContent = (me.email||me.userId||'User') + ' • ' + (me.role||'');
    if((me.role||'') !== 'admin') { err('Forbidden: Admin only'); return; }

    const data = await apiJson('/api/users');
    renderList(document.getElementById('creatorList'), data.creators, 'creator');
    renderList(document.getElementById('viewerList'), data.viewers, 'viewer');
  }

  document.getElementById('addCreator').onclick = async ()=>{
    const email = document.getElementById('creatorEmail').value.trim();
    if(!email) return;
    try{ await apiJson('/api/users', { method:'POST', body: JSON.stringify({ role:'creator', email }) }); document.getElementById('creatorEmail').value=''; await load(); ok('Added'); }
    catch(e){ err(e.message); }
  };
  document.getElementById('addViewer').onclick = async ()=>{
    const email = document.getElementById('viewerEmail').value.trim();
    if(!email) return;
    try{ await apiJson('/api/users', { method:'POST', body: JSON.stringify({ role:'viewer', email }) }); document.getElementById('viewerEmail').value=''; await load(); ok('Added'); }
    catch(e){ err(e.message); }
  };

  document.getElementById('logout').onclick = async ()=>{ try{ await apiJson('/api/auth/logout',{method:'POST'});}catch(e){} location.href='/login.html'; };

  load().catch(e=>err(e.message));
</script>
</body>
</html>
