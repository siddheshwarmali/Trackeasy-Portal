<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-50 flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white border rounded-2xl p-6 shadow">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-slate-900">Sign in</h1>
        <p class="text-sm text-slate-500 mt-1">Use your User ID and password</p>
      </div>
      <span id="statusPill" class="text-[11px] px-2 py-1 rounded-full bg-slate-100 border border-slate-200 text-slate-600">Checking server…</span>
    </div>

    <div id="err" class="hidden mt-4 text-sm bg-red-50 border border-red-200 text-red-800 rounded-lg p-3 whitespace-pre-wrap break-words"></div>
    <div id="ok" class="hidden mt-4 text-sm bg-green-50 border border-green-200 text-green-800 rounded-lg p-3 whitespace-pre-wrap break-words"></div>

    <label class="block mt-5 text-xs text-slate-600">User ID</label>
    <input id="userId" class="w-full border rounded-lg px-3 py-2 text-sm" autocomplete="username" />

    <label class="block mt-3 text-xs text-slate-600">Password</label>
    <input id="password" type="password" class="w-full border rounded-lg px-3 py-2 text-sm" autocomplete="current-password" />

    <button id="btn" class="mt-5 w-full px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm">Login</button>

    <div class="mt-4 text-[11px] text-slate-500 flex items-center justify-between">
      <a class="text-blue-600 underline" href="/api/ping" target="_blank">Open /api/ping</a>
      <button id="recheck" class="text-blue-600 underline" type="button">Re-check server</button>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
const showErr = (t)=>{ $('err').textContent = String(t); $('err').classList.remove('hidden'); $('ok').classList.add('hidden'); };
const showOk  = (t)=>{ $('ok').textContent  = String(t); $('ok').classList.remove('hidden'); $('err').classList.add('hidden'); };
const setPill = (text, kind='neutral')=>{
  const el = $('statusPill');
  el.textContent = text;
  el.className = 'text-[11px] px-2 py-1 rounded-full border ' + (
    kind==='ok' ? 'bg-green-50 border-green-200 text-green-700' :
    kind==='bad' ? 'bg-red-50 border-red-200 text-red-700' :
    'bg-slate-100 border-slate-200 text-slate-600'
  );
};

function withTimeout(ms){
  const controller = new AbortController();
  const t = setTimeout(()=>controller.abort(), ms);
  return { signal: controller.signal, done: ()=>clearTimeout(t) };
}

async function getText(url){
  const tmo = withTimeout(8000);
  try{
    const r = await fetch(url, { method:'GET', headers:{'Accept':'application/json'}, signal: tmo.signal });
    const txt = await r.text();
    return { ok:r.ok, status:r.status, text: txt };
  } finally { tmo.done(); }
}

async function checkServer(){
  setPill('Checking server…');
  try{
    const out = await getText('/api/ping');
    if(out.status === 404){
      setPill('API not deployed (404)', 'bad');
      showErr('Server API routes not found. This means /api is not deployed in Vercel.

Fix: Ensure the repository root contains an /api folder (not nested), and Vercel Root Directory points to that folder.');
      return;
    }
    if(!out.ok){
      setPill('API error', 'bad');
      showErr('Server reachable but returned error:
' + out.text);
      return;
    }
    let j=null;
    try{ j = JSON.parse(out.text||'{}'); }catch{ j=null; }
    setPill('Server OK', 'ok');
    if(j && j.env){
      const missing = Object.entries(j.env).filter(([k,v])=> (k==='GITHUB_BRANCH'?false:!v)).map(([k])=>k);
      if(missing.length){
        showErr('Server is running, but ENV VARS are missing in Vercel:
- ' + missing.join('
- ') + '

Add them in Vercel → Project Settings → Environment Variables, then Redeploy.');
      } else {
        showOk('Server is ready. You can login.');
      }
    }
  } catch(e){
    setPill('Cannot reach server', 'bad');
    showErr('Network error while calling /api/ping:
' + (e && e.message ? e.message : String(e)) + '

If you are opening this file locally (file://), it will fail. Use the deployed Vercel URL.');
  }
}

async function postJson(url, body){
  const tmo = withTimeout(12000);
  try{
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(body),
      signal: tmo.signal
    });
    const txt = await r.text();
    let j=null;
    try{ j=JSON.parse(txt||'{}'); }catch{ j=null; }
    if(!r.ok){
      const errVal = (j && (j.error ?? j.message)) ?? txt ?? ('HTTP '+r.status);
      throw new Error(typeof errVal === 'object' ? JSON.stringify(errVal) : String(errVal));
    }
    return j;
  } finally { tmo.done(); }
}

$('btn').addEventListener('click', async ()=>{
  $('btn').disabled = true;
  try{
    const uid = $('userId').value.trim();
    const pw  = $('password').value;
    const res = await postJson('/api/auth/login', { userId: uid, password: pw });
    showOk('Login successful. Redirecting…');
    const next = new URLSearchParams(location.search).get('next') || '/';
    location.href = next;
  } catch(e){
    showErr(e && e.message ? e.message : String(e));
  } finally {
    $('btn').disabled = false;
  }
});

$('recheck').addEventListener('click', checkServer);
checkServer();
</script>
</body>
</html>
